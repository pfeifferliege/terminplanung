<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terminplaner ‚Äì Taxi Pfeiffer</title>
  <style>
    :root {
      --bg: #f9f9fb;
      --card: #ffffff;
      --primary: #4a90e2;
      --primary-hover: #357ab8;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
      --whatsapp: #25D366;
      --text: #333;
      --text-dim: #666;
      --border: #ddd;
      --radius: 12px;
      --shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem;
    }
    .container { max-width: 1200px; margin: auto; }
    .app-title { font-size: 1.6rem; margin-bottom: 1rem; }
    .grid { display: grid; gap: 1rem; }
    .cols-2 { grid-template-columns: 1fr 1fr; }
    @media(max-width:800px){ .cols-2 { grid-template-columns: 1fr; } }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
      display:flex; flex-direction:column;
    }
    .hd { font-weight:bold; margin-bottom:.5rem; }
    .bd { flex:1; }
    form div { margin-bottom:.6rem; }
    label { display:block; font-size:.85rem; margin-bottom:2px; color: var(--text-dim); }
    input, select, textarea {
      width:100%; padding:.4rem .5rem;
      border:1px solid var(--border); border-radius:6px;
      font-size:1rem;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); outline:none; }
    .actions { display:flex; gap:.5rem; flex-wrap:wrap; }
    button {
      padding:.5rem .8rem; border:none; border-radius:6px;
      cursor:pointer; font-size:.9rem;
    }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-primary:hover { background:var(--primary-hover); }
    .btn-ghost { background:#eee; }
    .btn-ghost:hover { background:#ccc; } /* Hinzugef√ºgt: Hover-Effekt f√ºr Share Button */
    .btn-danger { background:var(--danger); color:#fff; }
    .btn-danger:hover { background:var(--danger-hover); }
    .btn-small { font-size:.8rem; padding:.3rem .5rem; }
    .btn-whatsapp { background:var(--whatsapp); color:#fff; }
    .pill { font-size:.9rem; font-weight:bold; color:var(--primary); }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:var(--primary); margin-right:4px; }
    .hr { border-top:1px solid var(--border); margin:.7rem 0; }
    .list .apt { border-bottom:1px solid var(--border); padding:.5rem 0; }
    .apt-head { display:flex; justify-content:space-between; font-weight:bold; flex-wrap:wrap; gap:.3rem; }
    .apt-meta { font-size:.85rem; color:var(--text-dim); margin:.2rem 0; }
    .footer { margin-top:1rem; display:flex; justify-content:space-between; align-items:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="app-title">Terminannahme</h1>

    <div class="grid cols-2">
      <section class="card" aria-labelledby="form-title">
        <div class="hd" id="form-title">Neuen Termin anlegen</div>
        <div class="bd">
          <form id="aptForm" onsubmit="Planner.saveAppointment(event)">
            <input type="hidden" id="editId" value="">
            <div>
              <label for="name">Name</label>
              <input id="name" list="nameList" placeholder="Name eingeben oder w√§hlen" required />
              <datalist id="nameList"></datalist>
            </div>

            <div>
              <label for="date">Termin</label>
              <input id="date" type="date" required />
            </div>

            <div>
              <label for="time">Uhrzeit</label>
              <input id="time" type="time" required />
            </div>

            <div>
              <label for="tripType">Terminart</label>
              <select id="tripType" required>
                <option value="">Bitte ausw√§hlen</option>
                <option value="Normalfahrt">Normalfahrt</option>
                <option value="Ambulanter Termin">Ambulanter Termin</option>
                <option value="Einweisung">Einweisung</option>
                <option value="Konsilfahrt">Konsilfahrt</option>
                <option value="Termin mit Wartezeit">Termin mit Wartezeit</option>
              </select>
            </div>

            <div>
              <label for="mobility">Bef√∂rderungsart</label>
              <select id="mobility" onchange="Planner.onMobilityChange()" required>
                <option value="">Bitte ausw√§hlen</option>
                <option>L√§ufer</option>
                <option>Rollstuhl</option>
                <option>Pflegerollstuhl</option>
                <option>Breiter Rollstuhl</option>
                <option>Tragestuhl</option>
                <option>Liegend</option>
                <option>Rollator</option>
              </select>
            </div>

            <div id="stairsExtra" class="hidden">
              <div>
                <label for="stairs">Anzahl Treppen</label>
                <input id="stairs" type="number" min="0" placeholder="0" />
              </div>
              <div>
                <label for="chairOwner">Rollstuhl</label>
                <select id="chairOwner">
                  <option value="">Bitte ausw√§hlen</option>
                  <option value="Eigener Rollstuhl">Eigener Rollstuhl</option>
                  <option value="Firmenrollstuhl">Firmenrollstuhl</option>
                </select>
              </div>
            </div>

            <div>
              <label for="payment">Zahlungsart</label>
              <select id="payment" onchange="Planner.onPaymentChange()" required>
                <option value="">Bitte ausw√§hlen</option>
                <option>Transportschein</option>
                <option>Bar</option>
                <option>EC</option>
                <option>Rechnung</option>
              </select>
            </div>

            <div id="tsExtra" class="hidden">
              <div>
                <label for="tsStatus">Zuzahlungsstatus</label>
                <select id="tsStatus">
                  <option value="">Bitte ausw√§hlen</option>
                  <option value="Befreit">Befreit</option>
                  <option value="Nicht befreit (EA auf Rechnung)">Nicht befreit (EA auf Rechnung)</option>
                </select>
              </div>
            </div>

            <div>
              <label for="escort">Begleitung</label>
              <select id="escort">
                <option value="">Bitte ausw√§hlen</option>
                <option value="Mit Begleitung">Mit Begleitung</option>
                <option value="Ohne Begleitung">Ohne Begleitung</option>
              </select>
            </div>

            <div>
              <label for="notes">Anmerkungen</label>
              <textarea id="notes" rows="3" placeholder="z. B. besondere Hinweise zur √úbernahme, Klingel, Mobilnummer, etc."></textarea>
            </div>

            <div class="hr"></div>
            <div><span class="pill"><span class="dot"></span> Startadresse</span></div>
            <div>
              <label for="startAddr">Adresse</label>
              <input id="startAddr" type="text" placeholder="Stra√üe Hausnr., PLZ Ort" />
            </div>

            <div class="hr"></div>
            <div><span class="pill"><span class="dot"></span> Zieladresse</span></div>
            <div>
              <label for="zielAddr">Adresse</label>
              <input id="zielAddr" type="text" placeholder="Stra√üe Hausnr., PLZ Ort" />
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">üíæ Termin speichern</button>
              <button type="button" class="btn-ghost" onclick="Planner.resetForm()">Formular zur√ºcksetzen</button>
            </div>
          </form>
        </div>
      </section>

      <section class="card" aria-labelledby="list-title">
        <div class="hd" id="list-title">Terminliste</div>
        <div class="bd">
          <div class="list" id="aptList"></div>
          <div class="footer">
            <span class="text-sm" id="counter" style="color:var(--text-dim)">0 Termine</span>
            <button class="btn-danger right" onclick="Planner.clearAll()">üóëÔ∏è Alle Termine l√∂schen</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const STORAGE = {
      names: 'planner_names_v1',
      apts: 'planner_apts_v1'
    };
    const $ = (sel, root=document) => root.querySelector(sel);

    const Planner = {
      state: { names: [], apts: [] },

      init(){
        this.state.names = this.load(STORAGE.names, []);
        this.state.apts = this.load(STORAGE.apts, []);
        this.refreshNameUI();
        this.renderList();
        const today = new Date();
        $('#date').value = today.toISOString().slice(0,10);
      },

      load(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback } },
      save(key, value){ localStorage.setItem(key, JSON.stringify(value)); },

      upsertName(name){
        const n = name.trim();
        if(!n) return;
        if(!this.state.names.includes(n)){
          this.state.names.push(n);
          this.state.names.sort((a,b)=> a.localeCompare(b,'de',{sensitivity:'base'}));
          this.save(STORAGE.names, this.state.names);
          this.refreshNameUI();
        }
      },
      refreshNameUI(){
        const dl = $('#nameList');
        dl.innerHTML = this.state.names.map(n=>`<option value="${this.escape(n)}"></option>`).join('');
      },

      saveAppointment(e){
        e.preventDefault();
        const name = $('#name').value.trim();
        this.upsertName(name);

        const editId = $('#editId').value;
        const newId = editId ? Number(editId) : Date.now(); // NEU: ID bestimmen

        const aptData = {
          id: newId, // NEU: ID verwenden
          name,
          date: $('#date').value,
          time: $('#time').value,
          tripType: $('#tripType').value,
          mobility: $('#mobility').value,
          stairs: $('#stairs')?.value,
          chairOwner: $('#chairOwner')?.value,
          payment: $('#payment').value,
          tsStatus: $('#tsStatus')?.value,
          escort: $('#escort')?.value,
          notes: $('#notes')?.value || '',
          startAddr: $('#startAddr').value,
          zielAddr: $('#zielAddr').value
        };

        if(editId){
          // Update bestehenden Termin
          const idx = this.state.apts.findIndex(a=>a.id===Number(editId));
          if(idx>-1) this.state.apts[idx] = aptData;
        } else {
          // Neu anlegen
          this.state.apts.unshift(aptData);
        }

        this.save(STORAGE.apts, this.state.apts);
        this.renderList();
        this.resetForm();
        
        // NEU: Sofort nach dem Speichern das Teilen-Fenster √∂ffnen
        this.shareApt(newId);
      },

      renderList(){
        const list = $('#aptList');
        if(this.state.apts.length===0){
          list.innerHTML = `<div class="empty-note">Noch keine Termine eingetragen.</div>`;
        } else {
          list.innerHTML = this.state.apts.map(apt=>{
            const dateFormatted = this.formatDate(apt.date);
            return `<div class="apt" data-id="${apt.id}">
              <div class="apt-head">
                <span class="apt-title">${this.escape(apt.name)}</span>
                <span class="apt-date">${dateFormatted}${apt.time? " ¬∑ "+this.escape(apt.time):""}</span>
              </div>
              <div class="apt-meta">
                <div>Terminart: ${this.escape(apt.tripType)}</div>
                <div>Bef√∂rderung: ${this.escape(apt.mobility)} ${apt.stairs? "(Treppen: "+this.escape(apt.stairs)+")":""} ${apt.chairOwner? "(Rollstuhl: "+this.escape(apt.chairOwner)+")":""}</div>
                <div>Zahlung: ${this.escape(apt.payment)} ${apt.tsStatus? "(Zuzahlungsstatus: "+this.escape(apt.tsStatus)+")":""}</div>
                <div>Begleitung: ${this.escape(apt.escort)}</div>
                <div>Anmerkungen: ${this.escape(apt.notes)}</div>
                <div>Startadresse: ${this.escape(apt.startAddr)}</div>
                <div>Zieladresse: ${this.escape(apt.zielAddr)}</div>
              </div>
              <div class="actions">
                <button class="btn-small btn-primary" onclick="Planner.editApt(${apt.id})">‚úèÔ∏è Bearbeiten</button>
                <button class="btn-small btn-ghost" onclick="Planner.shareApt(${apt.id})">üì§ Teilen</button>
                <button class="btn-small btn-whatsapp" onclick="Planner.sendWhatsApp(${apt.id})">WhatsApp</button>
                <button class="btn-small btn-danger" onclick="Planner.deleteApt(${apt.id})">L√∂schen</button>
              </div>
            </div>`
          }).join('');
        }
        $('#counter').textContent = `${this.state.apts.length} Termin(e)`;
      },

      formatDate(dateStr){
        if(!dateStr) return "";
        const d = new Date(dateStr);
        if(isNaN(d)) return this.escape(dateStr);
        // Datum ist von Date-Picker: d.setHours(d.getHours()+2) um Zeitzonen-Probleme zu vermeiden (f√ºr Anzeige)
        d.setHours(d.getHours()+2);
        return d.toLocaleDateString('de-DE',{day:'2-digit', month:'2-digit', year:'numeric'});
      },

      editApt(id){
        const apt = this.state.apts.find(a=>a.id===id);
        if(!apt) return;
        $('#editId').value = apt.id;
        $('#name').value = apt.name;
        $('#date').value = apt.date;
        $('#time').value = apt.time;
        $('#tripType').value = apt.tripType;
        $('#mobility').value = apt.mobility;
        this.onMobilityChange();
        if(apt.stairs) $('#stairs').value = apt.stairs;
        if(apt.chairOwner) $('#chairOwner').value = apt.chairOwner;
        $('#payment').value = apt.payment;
        this.onPaymentChange();
        if(apt.tsStatus) $('#tsStatus').value = apt.tsStatus;
        $('#escort').value = apt.escort;
        $('#notes').value = apt.notes;
        $('#startAddr').value = apt.startAddr;
        $('#zielAddr').value = apt.zielAddr;
        window.scrollTo({top:0, behavior:'smooth'});
      },

      deleteApt(id){
        if(confirm('Diesen Termin wirklich l√∂schen?')){
          this.state.apts = this.state.apts.filter(a=>a.id!==id);
          this.save(STORAGE.apts,this.state.apts);
          this.renderList();
        }
      },

      clearAll(){
        if(confirm('Alle Termine unwiderruflich l√∂schen?')){
          this.state.apts=[];
          this.save(STORAGE.apts,this.state.apts);
          this.renderList();
        }
      },

      resetForm(){ 
        $('#aptForm').reset(); 
        $('#editId').value = '';
        $('#stairsExtra').classList.add('hidden'); 
        $('#tsExtra').classList.add('hidden'); 
      },

      onMobilityChange(){ $('#stairsExtra').classList.toggle('hidden',$('#mobility').value!=='Tragestuhl'); },
      onPaymentChange(){ $('#tsExtra').classList.toggle('hidden',$('#payment').value!=='Transportschein'); },

      escape(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) },

      // NEU: Funktion zur Erstellung des Textes f√ºr Share/WhatsApp
      generateShareText(apt, forWhatsApp = false){
        const star = forWhatsApp ? '*' : '';
        const header = `${star}Neuer Termin f√ºr die √úbernahme aus der App "Terminannahme"${star}`;
        const date = this.formatDate(apt.date) || apt.date || '';
        const time = apt.time || '';
        const parts = [
          header,
          '',
          `${star}Name:${star} ${apt.name || ''}`,
          `${star}Datum:${star} ${date}${time? ' ¬∑ '+time : ''}`,
          `${star}Terminart:${star} ${apt.tripType || ''}`,
          `${star}Bef√∂rderung:${star} ${apt.mobility || ''}${apt.stairs? ' (Treppen: '+apt.stairs+')':''}${apt.chairOwner? ' (Rollstuhl: '+apt.chairOwner+')':''}`,
          `${star}Zahlung:${star} ${apt.payment || ''}${apt.tsStatus? ' (Zuzahlungsstatus: '+apt.tsStatus+')':''}`,
          `${star}Begleitung:${star} ${apt.escort || ''}`,
          apt.notes? `${star}Anmerkungen:${star} ${apt.notes}`:'',
          `${star}Startadresse:${star} ${apt.startAddr || ''}`,
          `${star}Zieladresse:${star} ${apt.zielAddr || ''}`
        ].filter(Boolean);
        return parts.join("\n");
      },

      // NEU: Allgemeine Teilen-Funktion (nutzt Web Share API oder Fallback)
      async shareApt(id){
        const apt = this.state.apts.find(a=>a.id===id);
        if(!apt) return alert('Termin nicht gefunden.');
        
        // Text ohne WhatsApp-Formatierung f√ºr die native Freigabe
        const shareText = this.generateShareText(apt, false);
        
        // Native Web Share API (bevorzugt)
        if (navigator.share) {
          try {
            await navigator.share({
              title: 'Neuer Termin',
              text: shareText
            });
            return; // Erfolgreich √ºber native API geteilt
          } catch (error) {
            // Fehler oder Abbruch, versuche Fallback (WhatsApp)
            console.warn('Web Share API nicht erfolgreich, verwende Fallback (WhatsApp).', error);
          }
        } 
        
        // Fallback: WhatsApp
        this.sendWhatsApp(id);
      },

      // Bestehende WhatsApp-Funktion (jetzt als Fallback oder separate Option)
      sendWhatsApp(id){
        const apt = this.state.apts.find(a=>a.id===id);
        if(!apt) return alert('Termin nicht gefunden.');
        
        // Text mit WhatsApp-Formatierung 
        const msgText = this.generateShareText(apt, true); 
        const msg = encodeURIComponent(msgText);
        
        // √ñffne WhatsApp-Link
        window.open(`https://wa.me/?text=${msg}`,'_blank');
      }
    };

    Planner.init();
  </script>
</body>
</html>



